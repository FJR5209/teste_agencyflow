<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagramas de Estrutura - AgencyFlow</title>
    <style>
        /* --- Estilos Gerais --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111827; /* gray-900 */
            color: #d1d5db; /* gray-300 */
            padding: 2rem;
        }

        h1, h2, h3 {
            color: #ffffff;
            border-bottom: 2px solid #374151; /* gray-700 */
            padding-bottom: 0.5rem;
            margin-bottom: 2rem;
        }
        
        /* --- Container do Diagrama --- */
        .diagram-container {
            position: relative;
            width: 100%;
            margin-bottom: 4rem;
            border: 1px solid #1f2937; /* gray-800 */
            background-color: #1f2937; /* gray-800 */
            padding: 2rem;
            border-radius: 0.75rem;
            min-height: 500px; /* Altura mínima para garantir espaço para as linhas */
            overflow: hidden; /* Garante que nada saia do card */
        }

        /* --- Estilos dos Nós (Caixas) --- */
        .node {
            position: absolute;
            background-color: #374151; /* gray-700 */
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            min-width: 150px;
            text-align: center;
            z-index: 10;
            cursor: grab; /* Indica que o elemento é arrastável */
            user-select: none; /* Impede a seleção de texto ao arrastar */
            transition: box-shadow 0.2s, transform 0.2s, border-color 0.2s;
        }
        .node.dragging {
            cursor: grabbing;
            z-index: 20;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.4);
            transform: scale(1.02);
        }
        .node.selected {
            box-shadow: 0 0 0 3px #8b5cf6; /* violet-500 */
            border-color: #a78bfa;
        }
        .node.highlighted {
            box-shadow: 0 0 0 3px #14b8a6; /* teal-500 */
            border-color: #2dd4bf; /* teal-400 */
        }
        
        /* Estilo para Entidades (ERD) */
        .entity {
            background-color: #064e3b; /* green-900 */
            border-color: #10b981; /* emerald-500 */
            text-align: left;
        }
        .entity-title {
            font-weight: bold;
            color: #ffffff;
            border-bottom: 1px solid #10b981;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .entity-fields {
            list-style-type: none;
            padding: 0;
            margin: 0;
            font-size: 0.875rem;
            color: #d1d5db;
        }

        /* Estilo para Módulos */
        .module {
            background-color: #1e3a8a; /* blue-900 */
            border-color: #60a5fa; /* blue-400 */
        }
        
        .flow-node {
             background-color: #4a5568;
             border-color: #a0aec0;
             border-radius: 9999px;
        }

        /* --- Estilos para Conectores SVG --- */
        .connector-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Permite clicar através do SVG */
            z-index: 1;
        }
        .connector-line {
            stroke: #9ca3af; /* gray-400 */
            stroke-width: 2;
            fill: none;
        }
        .connector-label {
            font-size: 12px;
            fill: #e5e7eb; /* gray-200 */
            text-anchor: middle;
        }
        .label-bg {
            fill: #1f2937; /* Cor de fundo do card */
        }
        marker {
            fill: #9ca3af;
        }

        /* --- Estilos da Seção Gemini AI --- */
        .gemini-container {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-top: 2rem;
        }
        .gemini-sparkle {
            display: inline-block;
            animation: sparkle 1.5s infinite;
        }
        @keyframes sparkle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(15deg); }
        }
        .gemini-form {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        #ai-target-node, #ai-action-select, #gemini-generate-btn {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #4b5563;
            background-color: #374151;
            color: #e5e7eb;
            font-size: 1rem;
        }
        #ai-target-node {
            flex-grow: 1;
            cursor: not-allowed;
            background-color: #111827;
        }
        #gemini-generate-btn {
            background-color: #6d28d9; /* violet-700 */
            border-color: #8b5cf6; /* violet-500 */
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        #gemini-generate-btn:hover {
            background-color: #5b21b6;
        }
        #gemini-result-container {
            background-color: #111827;
            padding: 1.5rem;
            border-radius: 0.5rem;
            min-height: 100px;
            border: 1px solid #374151;
            margin-top: 1rem;
        }
        #gemini-result {
            white-space: pre-wrap; /* Quebra de linha */
            word-wrap: break-word;
            font-family: monospace;
            color: #a7f3d0; /* emerald-200 */
        }
        #gemini-loader {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
        }

    </style>
</head>
<body>

    <h1>Diagramas de Estrutura - AgencyFlow (Interativo)</h1>

    <!-- 1. Diagrama de Entidade-Relacionamento (ERD) -->
    <div class="diagram-container" id="erd-container" style="min-height: 650px;">
        <h2>1. Diagrama de Entidade-Relacionamento (ERD)</h2>
        <svg class="connector-svg" id="erd-svg"></svg>
        <div id="erd-usuario" class="node entity" style="top: 100px; left: 250px;"><div class="entity-title">USUARIO</div><ul class="entity-fields"><li>id (PK)</li><li>nome</li><li>email</li><li>status</li></ul></div>
        <div id="erd-role" class="node entity" style="top: 100px; left: 50px;"><div class="entity-title">ROLE</div><ul class="entity-fields"><li>id (PK)</li><li>nome</li></ul></div>
        <div id="erd-cliente" class="node entity" style="top: 100px; left: 800px;"><div class="entity-title">CLIENTE</div><ul class="entity-fields"><li>id (PK)</li><li>nome</li><li>email</li><li>whatsapp</li><li>urlFoto</li><li>status</li></ul></div>
        <div id="erd-job" class="node entity" style="top: 300px; left: 450px;"><div class="entity-title">JOB</div><ul class="entity-fields"><li>id (PK)</li><li>titulo</li><li>tipo</li><li>status</li><li>dataEntrega</li></ul></div>
        <div id="erd-roteiro" class="node entity" style="top: 500px; left: 450px;"><div class="entity-title">ROTEIRO</div><ul class="entity-fields"><li>id (PK)</li><li>titulo</li><li>status</li></ul></div>
        <div id="erd-anexo" class="node entity" style="top: 500px; left: 800px;"><div class="entity-title">ANEXO</div><ul class="entity-fields"><li>id (PK)</li><li>nomeFicheiro</li><li>urlFicheiro</li></ul></div>
    </div>

    <!-- 2. Diagrama de Relação entre Módulos -->
    <div class="diagram-container" id="modules-container" style="min-height: 600px;">
        <h2>2. Diagrama de Relação entre Módulos</h2>
        <svg class="connector-svg" id="modules-svg"></svg>
        <div id="mod-jobs" class="node module" style="top: 250px; left: 45%;"><b>Jobs (Kanban)</b></div>
        <div id="mod-users" class="node module" style="top: 250px; left: 5%;"><b>Usuários e Permissões</b></div>
        <div id="mod-clients" class="node module" style="top: 250px; left: 25%;"><b>Clientes (CRM)</b></div>
        <div id="mod-scripts" class="node module" style="top: 250px; left: 65%;"><b>Roteiros</b></div>
        <div id="mod-reports" class="node module" style="top: 100px; left: 45%;"><b>Relatórios</b></div>
        <div id="mod-settings" class="node module" style="top: 450px; left: 45%;"><b>Configurações</b></div>
    </div>
    
    <h3>3. Diagramas de Fluxo por Perfil</h3>
    
    <!-- Diagrama do Admin -->
    <div class="diagram-container" id="admin-flow-container" style="min-height: 700px;">
        <h4>Fluxo do Administrador</h4>
        <svg class="connector-svg" id="admin-flow-svg"></svg>
        <div id="admin-login" class="node flow-node" style="top: 350px; left: 2%;">Login</div>
        <div id="admin-dash" class="node flow-node" style="top: 350px; left: 15%;">Dashboard Geral</div>
        <div id="admin-gest-users" class="node flow-node" style="top: 100px; left: 30%;">Gestão de Usuários</div>
        <div id="admin-crud-users" class="node flow-node" style="top: 100px; left: 50%;">Criar/Editar/Excluir Usuários</div>
        <div id="admin-def-roles" class="node flow-node" style="top: 100px; left: 75%;">Definir Papéis e Permissões</div>
        <div id="admin-gest-clients" class="node flow-node" style="top: 225px; left: 30%;">Gestão de Clientes</div>
        <div id="admin-crud-clients" class="node flow-node" style="top: 225px; left: 50%;">Criar/Editar/Excluir Clientes</div>
        <div id="admin-sup-proj" class="node flow-node" style="top: 350px; left: 30%;">Supervisão de Projetos</div>
        <div id="admin-view-jobs" class="node flow-node" style="top: 350px; left: 50%;">Visualizar todos os Jobs</div>
        <div id="admin-crud-jobs" class="node flow-node" style="top: 350px; left: 70%;">Criar/Editar/Excluir Job</div>
        <div id="admin-assign-jobs" class="node flow-node" style="top: 350px; left: 90%;">Atribuir Managers</div>
        <div id="admin-gest-config" class="node flow-node" style="top: 475px; left: 30%;">Configurações do Sistema</div>
        <div id="admin-edit-config" class="node flow-node" style="top: 475px; left: 50%;">Editar Dados da Empresa</div>
    </div>

    <!-- Diagrama do Manager -->
    <div class="diagram-container" id="manager-flow-container" style="min-height: 500px;">
        <h4>Fluxo do Manager</h4>
        <svg class="connector-svg" id="manager-flow-svg"></svg>
        <div id="man-login" class="node flow-node" style="top: 250px; left: 2%;">Login</div>
        <div id="man-dash" class="node flow-node" style="top: 250px; left: 18%;">Dashboard Pessoal/Equipe</div>
        <div id="man-kanban" class="node flow-node" style="top: 100px; left: 35%;">Acessar Kanban</div>
        <div id="man-create-job" class="node flow-node" style="top: 50px; left: 55%;">Criar Jobs</div>
        <div id="man-briefing" class="node flow-node" style="top: 50px; left: 75%;">Preencher Briefing</div>
        <div id="man-assign" class="node flow-node" style="top: 50px; left: 90%;">Atribuir Tarefas</div>
        <div id="man-edit-job" class="node flow-node" style="top: 150px; left: 55%;">Editar/Acompanhar Jobs</div>
        <div id="man-comment" class="node flow-node" style="top: 150px; left: 75%;">Comentar, Anexar, Mover</div>
        <div id="man-clients" class="node flow-node" style="top: 250px; left: 35%;">Gestão de Clientes</div>
        <div id="man-crud-clients" class="node flow-node" style="top: 250px; left: 55%;">Criar/Editar Clientes</div>
        <div id="man-reports" class="node flow-node" style="top: 350px; left: 35%;">Relatórios</div>
        <div id="man-gen-reports" class="node flow-node" style="top: 350px; left: 55%;">Gerar Relatórios de Produtividade</div>
        <div id="man-perms" class="node flow-node" style="top: 450px; left: 35%;">Permissões Restritas</div>
        <div id="man-no-access" class="node flow-node" style="top: 450px; left: 55%;">Sem acesso a Config. e Usuários</div>
    </div>
    
    <!-- Diagrama do Criativo -->
    <div class="diagram-container" id="creative-flow-container" style="min-height: 400px;">
        <h4>Fluxo do Criativo (Designer, etc.)</h4>
        <svg class="connector-svg" id="creative-flow-svg"></svg>
        <div id="cre-login" class="node flow-node" style="top: 180px; left: 2%;">Login</div>
        <div id="cre-dash" class="node flow-node" style="top: 180px; left: 15%;">Dashboard "Meu Dia"</div>
        <div id="cre-kanban" class="node flow-node" style="top: 100px; left: 30%;">Acessar Kanban</div>
        <div id="cre-view-jobs" class="node flow-node" style="top: 100px; left: 50%;">Visualizar Jobs Atribuídos</div>
        <div id="cre-open-task" class="node flow-node" style="top: 100px; left: 70%;">Abrir Tarefa</div>
        <div id="cre-perms" class="node flow-node" style="top: 260px; left: 30%;">Permissão Negada</div>
        <div id="cre-no-access" class="node flow-node" style="top: 260px; left: 50%;">Sem acesso a módulos restritos</div>
    </div>

    <!-- Diagrama do Cliente -->
    <div class="diagram-container" id="client-flow-container" style="min-height: 500px;">
        <h4>Fluxo do Cliente</h4>
        <svg class="connector-svg" id="client-flow-svg"></svg>
        <div id="cli-login" class="node flow-node" style="top: 250px; left: 2%;">Login no Portal</div>
        <div id="cli-dash" class="node flow-node" style="top: 250px; left: 20%;">Dashboard Personalizado</div>
        <div id="cli-kanban" class="node flow-node" style="top: 175px; left: 40%;">Kanban Simplificado</div>
        <div id="cli-track" class="node flow-node" style="top: 100px; left: 60%;">Acompanhar Progresso</div>
        <div id="cli-view-attach" class="node flow-node" style="top: 250px; left: 60%;">Ver Roteiros e Anexos</div>
        <div id="cli-approve" class="node flow-node" style="top: 250px; left: 80%;">Comentar/Aprovar</div>
        <div id="cli-perms" class="node flow-node" style="top: 325px; left: 40%;">Permissões Restritas</div>
        <div id="cli-no-access" class="node flow-node" style="top: 325px; left: 60%;">Sem acesso a dados de outros</div>
    </div>

    <!-- 4. Assistente IA com Gemini -->
    <div class="gemini-container">
        <h2><span class="gemini-sparkle">✨</span> Assistente IA com Gemini</h2>
        <p>Clique num bloco em qualquer diagrama acima para o selecionar e, em seguida, peça à IA para explicar, sugerir campos ou gerar um roteiro de teste.</p>
        <div class="gemini-form">
            <input type="text" id="ai-target-node" placeholder="Nenhum bloco selecionado" readonly>
            <select id="ai-action-select">
                <option value="explain">Explicar o que é</option>
                <option value="suggest_fields">Sugerir novos campos</option>
                <option value="test_cases">Gerar roteiro de teste</option>
            </select>
            <button id="gemini-generate-btn">Gerar Resposta</button>
        </div>
        <div id="gemini-result-container">
            <div id="gemini-loader" style="display: none;">A pensar... Por favor, aguarde.</div>
            <pre id="gemini-result"></pre>
        </div>
    </div>


    <script>
        // --- MAPA DE INTERLIGAÇÕES ---
        const diagramInterconnections = {
            // Entidades -> Módulos e Fluxos
            'erd-job': ['mod-jobs', 'admin-sup-proj', 'man-kanban', 'cre-kanban', 'cli-kanban'],
            'erd-cliente': ['mod-clients', 'admin-gest-clients', 'man-clients', 'cli-login'],
            'erd-usuario': ['mod-users', 'admin-gest-users'],
            'erd-role': ['admin-def-roles'],
            'erd-roteiro': ['mod-scripts', 'cli-view-attach'],
            // Módulos -> Entidades e Fluxos
            'mod-jobs': ['erd-job', 'erd-roteiro', 'erd-anexo'],
            'mod-clients': ['erd-cliente'],
            'mod-users': ['erd-usuario', 'erd-role'],
            'mod-reports': ['admin-gen-reports', 'man-gen-reports'],
            'mod-settings': ['admin-edit-config'],
            // Fluxos -> Módulos e Entidades
            'man-create-job': ['mod-jobs', 'erd-job'],
            'man-crud-clients': ['mod-clients', 'erd-cliente'],
            'admin-crud-users': ['mod-users', 'erd-usuario'],
            'cli-approve': ['erd-anexo', 'mod-jobs']
        };

        // Função para desenhar uma linha SVG curva entre dois elementos HTML
        function drawConnector(svgId, startElemId, endElemId, labelText, options = {}) {
            const svg = document.getElementById(svgId);
            const startElem = document.getElementById(startElemId);
            const endElem = document.getElementById(endElemId);
            if (!svg || !startElem || !endElem) return;

            if (!svg.querySelector('#arrow') && options.useArrow !== false) {
                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                marker.setAttribute('id', 'arrow');
                marker.setAttribute('viewBox', '0 0 10 10'); marker.setAttribute('refX', '8'); marker.setAttribute('refY', '5');
                marker.setAttribute('markerWidth', '6'); marker.setAttribute('markerHeight', '6'); marker.setAttribute('orient', 'auto-start-reverse');
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', 'M 0 0 L 10 5 L 0 10 z');
                marker.appendChild(path); defs.appendChild(marker); svg.appendChild(defs);
            }

            const containerRect = svg.parentElement.getBoundingClientRect();
            
            function getOptimalPoints(startEl, endEl) {
                const startRect = startEl.getBoundingClientRect(); const endRect = endEl.getBoundingClientRect();
                const startPoints = {
                    top: { x: startRect.left + startRect.width / 2, y: startRect.top }, right: { x: startRect.right, y: startRect.top + startRect.height / 2 },
                    bottom: { x: startRect.left + startRect.width / 2, y: startRect.bottom }, left: { x: startRect.left, y: startRect.top + startRect.height / 2 },
                };
                const endPoints = {
                    top: { x: endRect.left + endRect.width / 2, y: endRect.top }, right: { x: endRect.right, y: endRect.top + endRect.height / 2 },
                    bottom: { x: endRect.left + endRect.width / 2, y: endRect.bottom }, left: { x: endRect.left, y: endRect.top + endRect.height / 2 },
                };
                let minDistance = Infinity; let bestPoints = {};
                for (const sKey in startPoints) {
                    for (const eKey in endPoints) {
                        const dist = Math.hypot(startPoints[sKey].x - endPoints[eKey].x, startPoints[sKey].y - endPoints[eKey].y);
                        if (dist < minDistance) { minDistance = dist; bestPoints = { start: startPoints[sKey], end: endPoints[eKey], startSide: sKey, endSide: eKey };}
                    }
                }
                return bestPoints;
            }

            const points = getOptimalPoints(startElem, endElem);
            const startX = points.start.x - containerRect.left; const startY = points.start.y - containerRect.top;
            const endX = points.end.x - containerRect.left; const endY = points.end.y - containerRect.top;
            let ctrl1X = startX, ctrl1Y = startY, ctrl2X = endX, ctrl2Y = endY;
            const offset = 60;
            switch (points.startSide) { case 'top': ctrl1Y -= offset; break; case 'bottom': ctrl1Y += offset; break; case 'left': ctrl1X -= offset; break; case 'right': ctrl1X += offset; break; }
            switch (points.endSide) { case 'top': ctrl2Y -= offset; break; case 'bottom': ctrl2Y += offset; break; case 'left': ctrl2X -= offset; break; case 'right': ctrl2X += offset; break; }
            const pathData = `M ${startX} ${startY} C ${ctrl1X} ${ctrl1Y}, ${ctrl2X} ${ctrl2Y}, ${endX} ${endY}`;
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.setAttribute('d', pathData); line.classList.add('connector-line');
            if (options.useArrow !== false) { line.setAttribute('marker-end', 'url(#arrow)'); }
            svg.appendChild(line);

            if (labelText) {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                const midX = (startX + endX) / 2 + (ctrl1X - startX + ctrl2X - endX) / 4; const midY = (startY + endY) / 2 + (ctrl1Y - startY + ctrl2Y - endY) / 4;
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', midX); text.setAttribute('y', midY); text.setAttribute('dy', '0.35em');
                text.classList.add('connector-label'); text.textContent = labelText;
                g.appendChild(text); const bbox = text.getBBox();
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', bbox.x - 4); rect.setAttribute('y', bbox.y - 2);
                rect.setAttribute('width', bbox.width + 8); rect.setAttribute('height', bbox.height + 4);
                rect.setAttribute('rx', 4); rect.classList.add('label-bg');
                g.insertBefore(rect, text); svg.appendChild(g);
            }
        }
        
        const allConnectors = [
            ['erd-svg', 'erd-role', 'erd-usuario', 'possui um', {useArrow: false}], ['erd-svg', 'erd-usuario', 'erd-job', 'cria/responsável', {useArrow: false}], ['erd-svg', 'erd-cliente', 'erd-job', 'é dono de', {useArrow: false}], ['erd-svg', 'erd-job', 'erd-roteiro', 'contém', {useArrow: false}], ['erd-svg', 'erd-job', 'erd-anexo', 'possui', {useArrow: false}], ['erd-svg', 'erd-roteiro', 'erd-anexo', 'possui', {useArrow: false}],
            ['modules-svg', 'mod-reports', 'mod-users'], ['modules-svg', 'mod-reports', 'mod-clients'], ['modules-svg', 'mod-reports', 'mod-jobs'], ['modules-svg', 'mod-users', 'mod-jobs'], ['modules-svg', 'mod-clients', 'mod-jobs'], ['modules-svg', 'mod-jobs', 'mod-scripts'], ['modules-svg', 'mod-settings', 'mod-reports'], ['modules-svg', 'mod-settings', 'mod-users'], ['modules-svg', 'mod-settings', 'mod-clients'], ['modules-svg', 'mod-settings', 'mod-jobs'], ['modules-svg', 'mod-settings', 'mod-scripts'],
            ['admin-flow-svg', 'admin-login', 'admin-dash'], ['admin-flow-svg', 'admin-dash', 'admin-gest-users'], ['admin-flow-svg', 'admin-gest-users', 'admin-crud-users'], ['admin-flow-svg', 'admin-crud-users', 'admin-def-roles'], ['admin-flow-svg', 'admin-dash', 'admin-gest-clients'], ['admin-flow-svg', 'admin-gest-clients', 'admin-crud-clients'], ['admin-flow-svg', 'admin-dash', 'admin-sup-proj'], ['admin-flow-svg', 'admin-sup-proj', 'admin-view-jobs'], ['admin-flow-svg', 'admin-view-jobs', 'admin-crud-jobs'], ['admin-flow-svg', 'admin-crud-jobs', 'admin-assign-jobs'], ['admin-flow-svg', 'admin-dash', 'admin-gest-config'], ['admin-flow-svg', 'admin-gest-config', 'admin-edit-config'],
            ['manager-flow-svg', 'man-login', 'man-dash'], ['manager-flow-svg', 'man-dash', 'man-kanban'], ['manager-flow-svg', 'man-kanban', 'man-create-job'], ['manager-flow-svg', 'man-create-job', 'man-briefing'], ['manager-flow-svg', 'man-briefing', 'man-assign'], ['manager-flow-svg', 'man-kanban', 'man-edit-job'], ['manager-flow-svg', 'man-edit-job', 'man-comment'], ['manager-flow-svg', 'man-dash', 'man-clients'], ['manager-flow-svg', 'man-clients', 'man-crud-clients'], ['manager-flow-svg', 'man-dash', 'man-reports'], ['manager-flow-svg', 'man-reports', 'man-gen-reports'], ['manager-flow-svg', 'man-dash', 'man-perms'], ['manager-flow-svg', 'man-perms', 'man-no-access'],
            ['creative-flow-svg', 'cre-login', 'cre-dash'], ['creative-flow-svg', 'cre-dash', 'cre-kanban'], ['creative-flow-svg', 'cre-kanban', 'cre-view-jobs'], ['creative-flow-svg', 'cre-view-jobs', 'cre-open-task'], ['creative-flow-svg', 'cre-dash', 'cre-perms'], ['creative-flow-svg', 'cre-perms', 'cre-no-access'],
            ['client-flow-svg', 'cli-login', 'cli-dash'], ['client-flow-svg', 'cli-dash', 'cli-kanban'], ['client-flow-svg', 'cli-kanban', 'cli-track'], ['client-flow-svg', 'cli-kanban', 'cli-view-attach'], ['client-flow-svg', 'cli-view-attach', 'cli-approve'], ['client-flow-svg', 'cli-dash', 'cli-perms'], ['client-flow-svg', 'cli-perms', 'cli-no-access'],
        ];

        function renderConnectors() {
            document.querySelectorAll('.connector-svg').forEach(svg => svg.innerHTML = '');
            allConnectors.forEach(conn => drawConnector(...conn));
        }

        // --- LÓGICA DE DRAG-AND-DROP E SELEÇÃO ---
        let activeNode = null;
        let selectedNode = null;
        let isDragging = false;
        let xOffset = 0, yOffset = 0;

        document.querySelectorAll('.diagram-container').forEach(container => {
            container.addEventListener('mousedown', dragStart);
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('mousemove', drag);
        });

        function dragStart(e) {
            if (e.target.closest('.node')) {
                isDragging = false;
                activeNode = e.target.closest('.node');
                xOffset = e.clientX - activeNode.getBoundingClientRect().left;
                yOffset = e.clientY - activeNode.getBoundingClientRect().top;
            }
        }

        function dragEnd(e) {
            if (activeNode) {
                if (!isDragging) {
                    selectNode(activeNode);
                }
                activeNode.classList.remove('dragging');
                activeNode = null;
            }
            isDragging = false;
        }

        function drag(e) {
            if (activeNode) {
                if (!isDragging) {
                    isDragging = true;
                    activeNode.classList.add('dragging');
                }
                e.preventDefault();
                const containerRect = activeNode.parentElement.getBoundingClientRect();
                let newX = e.clientX - containerRect.left - xOffset;
                let newY = e.clientY - containerRect.top - yOffset;
                newX = Math.max(0, Math.min(newX, containerRect.width - activeNode.offsetWidth));
                newY = Math.max(0, Math.min(newY, containerRect.height - activeNode.offsetHeight));
                activeNode.style.left = newX + 'px';
                activeNode.style.top = newY + 'px';
                renderConnectors();
            }
        }

        function selectNode(node) {
            // Limpa seleções e destaques anteriores
            document.querySelectorAll('.node.selected, .node.highlighted').forEach(n => {
                n.classList.remove('selected', 'highlighted');
            });
            
            selectedNode = node;
            selectedNode.classList.add('selected');
            
            // Atualiza UI da IA
            const targetInput = document.getElementById('ai-target-node');
            targetInput.value = selectedNode.textContent.split('\n')[0].trim();
            targetInput.dataset.nodeId = selectedNode.id;

            // Destaca nós interligados
            const relatedIds = diagramInterconnections[selectedNode.id] || [];
            relatedIds.forEach(id => {
                const relatedNode = document.getElementById(id);
                if (relatedNode) {
                    relatedNode.classList.add('highlighted');
                }
            });
        }

        // --- LÓGICA DA GEMINI API ---
        const generateBtn = document.getElementById('gemini-generate-btn');
        const resultEl = document.getElementById('gemini-result');
        const loaderEl = document.getElementById('gemini-loader');

        generateBtn.addEventListener('click', async () => {
            if (!selectedNode) {
                alert('Por favor, selecione um bloco primeiro clicando nele.');
                return;
            }
            const targetNodeName = document.getElementById('ai-target-node').value;
            const action = document.getElementById('ai-action-select').value;
            let prompt = "";
            switch(action) {
                case 'explain': prompt = `No contexto de um sistema de gestão de agências chamado AgencyFlow, explique de forma clara e concisa o que é a entidade ou módulo "${targetNodeName}" e qual a sua principal função. Responda em Português.`; break;
                case 'suggest_fields': prompt = `Para a entidade "${targetNodeName}" no sistema AgencyFlow, sugira 3 a 5 campos ou atributos adicionais que seriam úteis. Forneça uma breve justificativa para cada sugestão. Formate a resposta como uma lista. Responda em Português.`; break;
                case 'test_cases': prompt = `Gere uma lista de 3 cenários de teste essenciais para validar a funcionalidade do módulo ou entidade "${targetNodeName}" no sistema AgencyFlow. Descreva cada caso de teste com um objetivo claro. Responda em Português.`; break;
            }
            if (!prompt) return;
            loaderEl.style.display = 'block'; resultEl.textContent = '';
            try {
                let chatHistory = []; chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory }; const apiKey = "AIzaSyAwqNXIUDDv1pN8V2KEoymGJl1Wn1RQ1Xg";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    resultEl.textContent = result.candidates[0].content.parts[0].text;
                } else {
                    resultEl.textContent = "Não foi possível obter uma resposta da IA. A resposta recebida estava vazia ou mal formatada."; console.error('Resposta inesperada da API:', result);
                }
            } catch (error) {
                resultEl.textContent = `Ocorreu um erro ao chamar a API do Gemini: ${error.message}\n\nPor favor, verifique a consola para mais detalhes.`; console.error('Erro na chamada da API:', error);
            } finally {
                loaderEl.style.display = 'none';
            }
        });
        
        window.addEventListener('load', renderConnectors);
        window.addEventListener('resize', renderConnectors);
    </script>
</body>
</html>
